#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

if [ -z "${1:-}" ]; then
    echo "Usage: configure-profile <ssh-public-key>"
    echo "Example: configure-profile 'ssh-ed25519 AAAA...'"
    exit 1
fi

SSH_PUBKEY="$1"

echo "Creating profile..."
incus profile create llm-coding-sandbox 2>/dev/null || echo "Profile already exists"

echo "Loading cloud-init config..."
incus profile edit llm-coding-sandbox < "$REPO_DIR/llm-coding-sandbox.yaml"

echo "Adding Claude settings device..."
incus profile device add llm-coding-sandbox claude-settings disk \
    source="$HOME/.claude/settings.json" \
    path=/root/.claude/settings.json \
    readonly=true 2>/dev/null || echo "Device already exists"

echo "Setting SSH public key..."
incus profile set llm-coding-sandbox cloud-init.user-data "#cloud-config
ssh_authorized_keys:
  - $SSH_PUBKEY"

echo "Done! Make sure your ~/.ssh/config includes:"
echo "  Include ~/.colima/ssh_config"
